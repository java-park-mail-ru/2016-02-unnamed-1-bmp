# Игровое взамодействие

## Начало игры

Перед началом игры пользователь должен быть авторизован. Авторизация может быть обычная (пользователь прошел регистрацию, авторизуется по логину и паролю), а также гостевая (пользователь указал свой логин, авторизовался, больше авторизоваться под тем же пользователем не сможет).

Чтобы начать игру, необходимо открыть сокет по урлу `/gameplay`.

## Сообщения для сервера

### initNewGame / Инициализация игры

```
{
  "action": "initNewGame",
  "mode": "bot",
  "ships": [
    [ 2, 2, 4, true ],
    [ 2, 7, 1, true ],
    [ 2, 9, 1, true ],
    [ 4, 3, 3, false ],
    [ 4, 6, 2, false ],
    [ 4, 9, 2, false ],
    [ 8, 2, 1, true ],
    [ 7, 5, 2, true ],
    [ 7, 9, 3, false ],
    [ 9, 4, 2, false ],
    [ 10, 6, 1, false ]
  ]
}
```

`mode` - режим игры (`bot` - с ботом, `random` - со случайным соперником, `friend` - со знакомым)
`ships` - корабли (каждый корабль - массив `[x начала, y начала, длина, вертикальный?]`)
`id` (дополнительный) - если `mode` = `friend`, то в этом поле можно указать id игровой сессии (для присоединения к игровой сессии)

Ответ: game_init

### getGameStatus / Получение статуса игры

```
{
  "action": "getGameStatus"
}
```

Ответ: game_status

### shoot / Выстрел

```
{
  "action": "shoot",
  "x": 6,
  "y": 1
}
```

`x` - координата x поля
`y` - координата y поля

Ответ: shoot_result

### giveUp / Сдаться

```
{
  "action": "giveUp"
}
```

Ответ: game_over

## Сообщение для клиента

### game_init / Инициализация игры

```
{
  "ok": true,
  "type": "game_init"
}
```

`ok` - успешно?
`id` (дополнительный) - если было отправлено сообщение initNewGame с `mode` = `friend`, то в этом поле будет id сессии, который может использовать знакомый противник для присоединения к игровой сессии

### game_start / Начало игры

```
{
  "ok": true,
  "type": "game_start",
  "opponentName": "Anonymous sheep"
}
```

`ok` - всегда `true`
`opponentName` - имя противника

### game_turn / Игровой ход

Сообщает о переходе хода 

```
{
  "ok": false,
  "type": "game_turn"
}
```

`ok` - `true` = ход этого игрока, `false` = ход соперника

### game_over / Конец игры

```
{
  "ok": true,
  "type": "game_turn",
  "score": 100
}
```

`ok` - `true` = победа, `false` = поражение
`score` - количество побед (рекорд игрока)


### shoot_result / Результат выстрела

```
{
  "ok": false,
  "type": "shoot_result",
  "status": "miss",
  "x": 6,
  "y": 1
}
```

```
{
  "ok": true,
  "type": "shoot_result",
  "status": "wound",
  "x": 5,
  "y": 9
}
```

```
{
  "ok": true,
  "type": "shoot_result",
  "status": "killed",
  "x": 4,
  "y": 9,
  "startX": 4,
  "startY": 9,
  "length": 2,
  "isVertical": false
}
```

`ok` - `true` = выстрел этим игроком, `false` = выстрел соперника
`status` - статус выстрела / корабля (`miss` - промах, `wound` - ранен, `killed` - убит, `already` - уже "раненая" клетка)
`x` - координата x поля
`y` - координата y поля
`startX` (дополнительный, для `status` = `killed`) - координата x начала корабля
`startY` (дополнительный, для `status` = `killed`) - координата y начала корабля
`length` (дополнительный, для `status` = `killed`) - длина корабля
`isVertical` (дополнительный, для `status` = `killed`) - корабль вертикальный?


### error / Ошибка

```
{
  "ok": false,
  "type": "error",
  "error": "Текст ошибки"
}
```

`ok` - всегда `false`
`error` - текст ошибки


### game_status / Статус игры

```
{
  "ok": true,
  "type": "game_status",
  "id": 1,
  "started": true,
  "ships": [
    [ 2, 2, 4, true ],
    [ 2, 7, 1, true ],
    [ 2, 9, 1, true ],
    [ 4, 3, 3, false ],
    [ 4, 6, 2, false ],
    [ 4, 9, 2, false ],
    [ 8, 2, 1, true ],
    [ 7, 5, 2, true ],
    [ 7, 9, 3, false ],
    [ 10, 6, 1, false ]
  ],
  "killedShips: [],
  "shoots": [
    [ 2, 8, false ],
    [ 8, 8, false ],
    [ 5, 9, true ],
    [ 4, 9, true ],
    [ 1, 8, false ]
  ],
  "opponentName": "Anonymous chameleon",
  "opponentShips": [],
  "opponentShoots": [
    [ 1, 1, false ],
    [ 1, 2, false ],
    [ 1, 3, true ],
    [ 1, 4, false ]
  ],
  "turn": true
}
```

`ok` - `true` - пользователь инициализировал игру, `false` - пользователь не инициализировал игру
`id` - id игровой сессии
`started` - игра началась
`ships` - корабли (каждый корабль - массив `[x начала, y начала, длина, вертикальный?]`)
`killedShips` - убитые корабли (каждый корабль - массив `[x начала, y начала, длина, вертикальный?]`)
`shoots` - выстрелы в поле текущего игрока (каждый выстрел - массив `[x, y, попал?]`)
`opponentName` - имя соперника
`opponentShips` - убитые корабли соперника (каждый корабль - массив `[x начала, y начала, длина, вертикальный?]`)
`opponentShoots` - выстрелы в после соперника ( каждый выстрел - массив `[x, y, попал?]`)
`turn` - `true` = ход этого игрока, `false` = ход соперника

### opponent_online / Онлайн-статус соперника

```
{
  "ok": true,
  "type": "opponent_online"
}
```

`ok` - `true` - соперник онлайн, `false` - соперник оффлайн


### game_too_long / Слишком долгая игра

```
{
  "ok": true,
  "type": "game_too_long"
}
```

`ok` - всегда `true`